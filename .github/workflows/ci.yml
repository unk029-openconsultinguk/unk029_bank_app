name: CI & Publish

# ----------------------------------------
# GitHub Repository Variables that must be set:
#   - OC_USERNAME: username for private PyPI
#   - OC_PASSWORD: password for private PyPI (stored as secret)
#   - OC_PUBLISH_URL: private PyPI index URL (without credentials)
#
# Notes:
#   - Major and Minor versions are determined by __about__.py / hatch version.
#   - Patch versions are automatically bumped for dev and release builds.
# ----------------------------------------

on:
  push:
    branches: [main]
  pull_request: {}

env:
  UV_VERSION: "0.8.3"
  HATCH_VERSION: "1.6.0"
  PYTHON_VERSION: "3.12"
  OC_PYPI: "https://${{ vars.OC_USERNAME }}:${{ secrets.OC_PASSWORD }}@${{ vars.OC_PUBLISH_URL }}/simple"

defaults:
  run:
    shell: bash

jobs:
  # -----------------------
  # QA
  # -----------------------
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Python & UV
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - uses: astral-sh/setup-uv@v5
        with:
          version: ${{ env.UV_VERSION }}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-${{ env.UV_VERSION }}-${{ hashFiles('uv.lock') }}
          restore-keys: uv-

      - name: Install dependencies
        env:
          UV_INDEX_USERNAME: ${{ vars.OC_USERNAME }}
          UV_INDEX_PASSWORD: ${{ secrets.OC_PASSWORD }}
        run: uv sync

      - name: Debug Nexus Auth
        run: |
          echo "Username: ${{ vars.OC_USERNAME }}"
          echo "Publish URL: ${{ vars.OC_PUBLISH_URL }}"
          echo "Python version: ${{ env.PYTHON_VERSION }}"
      - name: Run lint
        env:
          UV_INDEX_USERNAME: ${{ vars.OC_USERNAME }}
          UV_INDEX_PASSWORD: ${{ secrets.OC_PASSWORD }}
        run: uv run nox -s lint

      - name: Run type check
        env:
          UV_INDEX_USERNAME: ${{ vars.OC_USERNAME }}
          UV_INDEX_PASSWORD: ${{ secrets.OC_PASSWORD }}
        run: uv run nox -s type_check

      - name: Run tests
        env:
          UV_INDEX_USERNAME: ${{ vars.OC_USERNAME }}
          UV_INDEX_PASSWORD: ${{ secrets.OC_PASSWORD }}
        run: uv run nox -s test-${{ env.PYTHON_VERSION }}

  # -----------------------
  # Release publish (main branch only)
  # -----------------------
  publish:
    needs: quality
    runs-on: self-hosted
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - uses: astral-sh/setup-uv@v5
        with:
          version: ${{ env.UV_VERSION }}

      - name: Install dependencies
        run: uv sync

      - name: Install Hatch
        run: pip install hatch==${{ env.HATCH_VERSION }}

      - name: Get package name from pyproject.toml
        id: pkgname
        run: |
          pkg=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['name'])")
          echo "package_name=$pkg" >> $GITHUB_OUTPUT

      - name: Determine next release version
        id: versioning
        run: |
          pkg_name="${{ steps.pkgname.outputs.package_name }}"
          major_minor=$(hatch version | awk -F. '{print $1"."$2}')
          uv pip install --upgrade pip
          latest=$(pip index versions $pkg_name --index-url "${OC_PYPI}" \
                   | grep -Eo '[0-9]+\.[0-9]+\.[0-9]+' \
                   | grep -v dev \
                   | sort -V \
                   | tail -n1 || echo "${major_minor}.0")
          IFS='.' read -ra parts <<< "$latest"
          next_patch=$((parts[2]+1))
          next_version="${parts[0]}.${parts[1]}.$next_patch"
          echo "Next release version: $next_version (latest was $latest)"
          echo "version=$next_version" >> $GITHUB_OUTPUT

      - name: Bump version
        run: hatch version ${{ steps.versioning.outputs.version }}

      - name: Build package
        run: hatch build

      - name: Publish to OC PyPI
        run: hatch publish -r "https://${{ vars.OC_PUBLISH_URL }}" -u "${{ vars.OC_USERNAME }}" -a "${{ secrets.OC_PASSWORD }}" dist/*.whl

  # -----------------------
  # Dev publish (PRs only)
  # -----------------------
  publish-dev:
    needs: quality
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - uses: astral-sh/setup-uv@v5
        with:
          version: ${{ env.UV_VERSION }}

      - name: Install dependencies
        env:
          UV_INDEX_USERNAME: ${{ vars.OC_USERNAME }}
          UV_INDEX_PASSWORD: ${{ secrets.OC_PASSWORD }}
        run: uv sync

      - name: Install Hatch
        run: pip install hatch==${{ env.HATCH_VERSION }}

      - name: Get package name from pyproject.toml
        id: pkgname
        run: |
          pkg=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['name'])")
          echo "package_name=$pkg" >> $GITHUB_OUTPUT

      - name: Determine next dev version
        id: versioning
        run: |
          pkg_name="${{ steps.pkgname.outputs.package_name }}"
          current_version=$(hatch version)
          major_minor=$(echo "$current_version" | awk -F. '{print $1"."$2}')
          patch=$(echo "$current_version" | awk -F. '{print $3}' | sed 's/[^0-9].*$//')
          
          # Get PR SHA in shell
          full_sha="${{ github.event.pull_request.head.sha }}"
          short_hash="${full_sha:0:7}"
          
          # Create dev version based on current version
          dev_version="${major_minor}.${patch}.dev${GITHUB_RUN_NUMBER}+g${short_hash}"
          echo "Next dev version: $dev_version (current was $current_version)"
          echo "version=$dev_version" >> $GITHUB_OUTPUT

      - name: Bump version
        run: hatch version ${{ steps.versioning.outputs.version }}

      - name: Build package
        run: hatch build

      - name: Publish dev package to OC PyPI
        run: hatch publish -r "https://${{ vars.OC_PUBLISH_URL }}" -u "${{ vars.OC_USERNAME }}" -a "${{ secrets.OC_PASSWORD }}" dist/*.whl
